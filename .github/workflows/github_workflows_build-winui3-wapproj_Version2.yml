on:
  workflow_dispatch:
  push:
    branches: [ main ]
    tags: [ "v*" ]

jobs:
  build:
    runs-on: windows-2022

    # ✅ 声明需要访问 secrets
    permissions:
      contents: read

    env:
      CONFIGURATION: Release
      PLATFORM: x64
      WAPPROJ_DIR: prosekatoolspackaging

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Locate wapproj
        shell: pwsh
        run: |
          $w = Get-ChildItem -Path "$env:WAPPROJ_DIR" -Filter *.wapproj -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if(-not $w){ throw "No .wapproj found under $env:WAPPROJ_DIR." }
          "WAPPROJ_PATH=$($w.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Restore
        run: |
          nuget restore
          msbuild "%WAPPROJ_PATH%" -t:Restore -p:Configuration=%CONFIGURATION% -p:Platform=%PLATFORM%

      # ✅ 构建（签名）
      - name: Build and Package (Signed)
        if: ${{ success() && secrets.WINDOWS_PFX }}
        shell: pwsh
        run: |
          [IO.File]::WriteAllText("cert.b64", "${{ secrets.WINDOWS_PFX }}")
          certutil -decode cert.b64 cert.pfx | Out-Null
          $pfx = Resolve-Path cert.pfx
          echo "PFX_PATH=$pfx" >> $env:GITHUB_ENV
        # build
        shell: cmd
        run: >
          msbuild "%WAPPROJ_PATH%"
          -t:Build
          -p:Configuration=%CONFIGURATION%
          -p:Platform=%PLATFORM%
          -p:GenerateAppxPackageOnBuild=true
          -p:AppxBundle=Always
          -p:AppxBundlePlatforms=%PLATFORM%
          -p:UapAppxPackageBuildMode=SideloadOnly
          -p:PackageCertificateKeyFile="%PFX_PATH%"
          -p:PackageCertificatePassword="${{ secrets.WINDOWS_PFX_PASSWORD }}"

      # ❎ 无证书构建
      - name: Build and Package (Unsigned)
        if: ${{ success() && !secrets.WINDOWS_PFX }}
        shell: cmd
        run: >
          msbuild "%WAPPROJ_PATH%"
          -t:Build
          -p:Configuration=%CONFIGURATION%
          -p:Platform=%PLATFORM%
          -p:GenerateAppxPackageOnBuild=true
          -p:AppxBundle=Always
          -p:AppxBundlePlatforms=%PLATFORM%
          -p:UapAppxPackageBuildMode=SideloadOnly

      - name: Find packages
        id: findpkg
        shell: pwsh
        run: |
          $pkgs = Get-ChildItem -Recurse -Include *.msix,*.msixbundle,*.msixupload | Select-Object -Expand FullName
          if(-not $pkgs){ throw "No packages produced." }
          $pkgs -join "`n"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-packages
          path: |
            **/*.msix
            **/*.msixbundle
            **/*.msixupload
